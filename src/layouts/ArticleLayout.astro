---
import BaseLayout from './BaseLayout.astro';
import type { CollectionEntry } from 'astro:content';
import { SITE_URL } from '../lib/constants';
import { calculateReadingTime, countWords, formatDateLong } from '../lib/utils';

interface Props {
  article: CollectionEntry<'articles'>;
}

const { article } = Astro.props;
const { data } = article;

const canonical = data.canonical || `${SITE_URL}/articles/${article.slug}`;
const readingTime = data.readingTime || calculateReadingTime(article.body);
const wordCount = data.wordCount || countWords(article.body);
---

<BaseLayout
  title={`${data.title} - Lab`}
  description={data.description}
  canonical={canonical}
  image={data.image}
  noindex={data.noindex}
  schemaType={data.schemaType}
>
  <article class="max-w-3xl mx-auto px-4 py-12">
    <!-- Article header -->
    <header class="mb-8">
      <div class="text-sm text-neutral-600 dark:text-neutral-500 mb-4 flex items-center gap-4">
        <time datetime={data.publishedAt.toISOString()}>
          {formatDateLong(data.publishedAt)}
        </time>
        <span>·</span>
        <span>{readingTime} min read</span>
        <span>·</span>
        <span>{wordCount} words</span>
      </div>

      <h1 class="text-4xl md:text-5xl font-bold mb-4 leading-tight">
        {data.title}
      </h1>

      <p class="text-xl text-neutral-600 dark:text-neutral-400 mb-6">
        {data.description}
      </p>

      <!-- Topic badge -->
      <div class="flex items-center gap-2">
        <a
          href={`/topics/${data.topic}`}
          class="inline-flex items-center px-3 py-1 rounded-full bg-primary-500/10 text-primary-500 text-sm font-medium hover:bg-primary-500/20 transition-colors"
        >
          {data.topic}
        </a>
        {data.tags?.map((tag) => <span class="text-sm text-neutral-600 dark:text-neutral-500">#{tag}</span>)}
      </div>
    </header>

    <!-- Article content -->
    <div class="prose prose-neutral dark:prose-invert prose-lg max-w-none">
      <slot />
    </div>

    <!-- Article footer with metadata -->
    {(data.lastUpdated || data.version) && (
      <footer class="mt-12 pt-8 border-t border-neutral-200 dark:border-neutral-800">
        <div class="text-sm text-neutral-600 dark:text-neutral-500">
          {data.lastUpdated && (
            <p class="mb-2">Last updated: {formatDateLong(data.lastUpdated)}</p>
          )}
          {data.version && <p>Version {data.version}</p>}
        </div>
      </footer>
    )}
  </article>
</BaseLayout>

<style is:global>
  /* Light mode prose */
  .prose {
    --tw-prose-body: theme('colors.neutral.700');
    --tw-prose-headings: theme('colors.neutral.900');
    --tw-prose-links: theme('colors.primary.600');
    --tw-prose-bold: theme('colors.neutral.900');
    --tw-prose-code: theme('colors.primary.600');
    --tw-prose-pre-bg: theme('colors.neutral.100');
    --tw-prose-quotes: theme('colors.neutral.600');
  }

  /* Dark mode prose */
  .dark .prose {
    --tw-prose-body: theme('colors.neutral.300');
    --tw-prose-headings: theme('colors.neutral.100');
    --tw-prose-links: theme('colors.primary.500');
    --tw-prose-bold: theme('colors.neutral.100');
    --tw-prose-code: theme('colors.primary.400');
    --tw-prose-pre-bg: theme('colors.neutral.900');
    --tw-prose-quotes: theme('colors.neutral.400');
  }

  .prose a {
    text-decoration: underline;
    text-decoration-color: theme('colors.primary.500/30');
    text-underline-offset: 3px;
    transition: text-decoration-color 0.2s;
  }

  .prose a:hover {
    text-decoration-color: theme('colors.primary.500');
  }

  .prose code {
    background-color: theme('colors.neutral.100');
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    font-size: 0.875em;
  }

  .dark .prose code {
    background-color: theme('colors.neutral.900');
  }

  .prose pre {
    background-color: theme('colors.neutral.100') !important;
    border: 1px solid theme('colors.neutral.200');
  }

  .dark .prose pre {
    background-color: theme('colors.neutral.900') !important;
    border: 1px solid theme('colors.neutral.800');
  }

  .prose pre code {
    background-color: transparent;
    padding: 0;
  }

  /* Remove underline from action buttons */
  .no-underline {
    text-decoration: none !important;
  }
</style>
