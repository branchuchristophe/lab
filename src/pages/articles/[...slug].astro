---
import { getCollection } from 'astro:content';
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import CoAuthorBadge from '../../components/CoAuthorBadge.astro';
import AgentActions from '../../components/AgentActions.astro';
import { getArticleUrl, calculateReadingTime, countWords, formatDate, generateClaudeUrl, generateChatGPTUrl } from '../../lib/utils';
import ChatIcon from '../../components/icons/ChatIcon.astro';
import GitHubIcon from '../../components/icons/GitHubIcon.astro';

export async function getStaticPaths() {
  const articles = await getCollection('articles');

  return articles.map((article) => ({
    params: { slug: article.slug },
    props: { article },
  }));
}

const { article } = Astro.props;
const { Content } = await article.render();

const articleUrl = getArticleUrl(article.slug);
const words = countWords(article.body);
const readingTime = calculateReadingTime(article.body);
---

<ArticleLayout article={article}>
  <!-- Top action bar: Read with AI -->
  <div class="flex flex-wrap items-center gap-3 mb-8 pb-6 border-b border-neutral-800">
    <span class="text-sm text-neutral-500">Read with:</span>
    <a
      href={article.data.claudeUrl || generateClaudeUrl(article.data.title, articleUrl, article.data.description)}
      target="_blank"
      rel="noopener noreferrer"
      class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm bg-primary-500/10 border border-primary-500/30 rounded-md hover:bg-primary-500/20 transition-colors text-primary-400"
    >
      <ChatIcon class="w-4 h-4" />
      Claude
    </a>
    <a
      href={article.data.chatgptUrl || generateChatGPTUrl(article.data.title, articleUrl, article.data.description)}
      target="_blank"
      rel="noopener noreferrer"
      class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm bg-green-500/10 border border-green-500/30 rounded-md hover:bg-green-500/20 transition-colors text-green-400"
    >
      <ChatIcon class="w-4 h-4" />
      ChatGPT
    </a>
    {article.data.githubUrl && (
      <a
        href={article.data.githubUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm bg-neutral-800/50 border border-neutral-700 rounded-md hover:bg-neutral-800 transition-colors text-neutral-300"
      >
        <GitHubIcon class="w-4 h-4" />
        Code
      </a>
    )}
  </div>

  <!-- Co-author badge (shown when coauthored) -->
  {
    article.data.coauthored && (
      <div class="mb-8">
        <CoAuthorBadge
          author={article.data.author}
          aiContributors={article.data.aiContributors}
          coauthorNote={article.data.coauthorNote}
          validationLevel={article.data.validationLevel}
          coauthored={article.data.coauthored}
        />
      </div>
    )
  }

  <!-- Article content (markdown rendered) -->
  <Content />

  <!-- Agent actions (read with AI, share) -->
  <AgentActions
    title={article.data.title}
    description={article.data.description}
    articleUrl={articleUrl}
    claudeUrl={article.data.claudeUrl}
    chatgptUrl={article.data.chatgptUrl}
    githubUrl={article.data.githubUrl}
    notebookUrl={article.data.notebookUrl}
  />

  <!-- Reading stats footer -->
  <div class="mt-12 pt-8 border-t border-neutral-800">
    <div class="flex items-center justify-between text-sm text-neutral-500">
      <div class="flex items-center gap-4">
        <span>{readingTime} min read</span>
        <span>·</span>
        <span>{words} words</span>
        {
          article.data.codeLanguages && article.data.codeLanguages.length > 0 && (
            <>
              <span>·</span>
              <span>Languages: {article.data.codeLanguages.join(', ')}</span>
            </>
          )
        }
      </div>
      {
        article.data.lastUpdated && (
          <time datetime={article.data.lastUpdated.toISOString()}>
            Updated {formatDate(article.data.lastUpdated)}
          </time>
        )
      }
    </div>
  </div>
</ArticleLayout>
